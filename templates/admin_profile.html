{% extends 'base.html' %}
{% block content %}
<h2>Edit profile</h2>

<form id="profile-form" method="post" class="admin-form" enctype="multipart/form-data">
  <label>Name<br><input name="name" value="{{ profile.name if profile and profile.name }}"></label>
  <label>Tagline<br><input name="tagline" value="{{ profile.tagline if profile and profile.tagline }}"></label>
  <label>Email<br><input name="email" value="{{ profile.email if profile and profile.email }}"></label>
  <label>Bio<br><textarea name="bio" rows="5">{{ profile.bio if profile and profile.bio }}</textarea></label>
  <label>LinkedIn URL<br><input name="linkedin" value="{{ profile.linkedin if profile and profile.linkedin }}"></label>
  <label>Twitter / X URL<br><input name="twitter" value="{{ profile.twitter if profile and profile.twitter }}"></label>
  <label>Profile image URL (or upload below)<br><input name="image_url" value="{{ profile.image_url if profile and profile.image_url }}"></label>
  <label>Upload profile image<br><input type="file" name="profile_image_file" accept="image/*"></label>

  <hr>
  <h4>About page gallery</h4>
  <p>Upload one or more images to show on the About page gallery.</p>
  <label>Image URLs (comma separated)<br><input name="about_images" placeholder="/static/uploads/1.jpg, https://..." value="{{ profile.about_images if profile and profile.about_images }}"></label>
  <label>Or upload images<br><input type="file" name="about_images_files" accept="image/*" multiple></label>

  <div style="margin-top:1rem;">
    <h4>Current gallery images</h4>
    <div id="gallery-preview" style="display:flex;gap:0.6rem;flex-wrap:wrap;">
      {%- set imgs = profile.get('about_images') or '' -%}
      {%- set imgs_list = imgs.split(',') if imgs else [] -%}
      {% for img in imgs_list %}
        {% if img %}
          <div style="position:relative; width:120px;">
            <img src="{{ img.strip() }}" style="width:100%;height:80px;object-fit:cover;border-radius:6px;" />
            <button class="btn-delete-image" data-image="{{ img.strip() }}" style="position:absolute;top:6px;right:6px;background:#fff;border:none;border-radius:4px;padding:4px;cursor:pointer;">Ã—</button>
          </div>
        {% endif %}
      {% else %}
        <div class="muted">No gallery images yet.</div>
      {% endfor %}
    </div>
  </div>

  <div id="form-status" style="margin-top: 1rem; font-weight: bold; display: none;"></div>
  <div style="margin-top: 2rem;">
      <button type="submit" id="save-btn">Save</button>
      <a href="{{ url_for('admin_index') }}" class="external" style="margin-left: 1rem;">Cancel</a>
  </div>
</form>

<script>
document.getElementById('profile-form').addEventListener('submit', async function(e){
  e.preventDefault();
  const statusDiv = document.getElementById('form-status');
  const saveBtn = document.getElementById('save-btn');
  const originalBtnText = saveBtn.textContent;
  saveBtn.textContent = 'Saving...';
  saveBtn.disabled = true;
  statusDiv.style.display = 'none';

  const formData = new FormData(this);
  try {
    const response = await fetch(window.location.href, {
      method: 'POST',
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });
    const result = await response.json();
    if (result.status === 'success') {
      saveBtn.textContent = 'Saved';
      setTimeout(() => { window.location.href = '{{ url_for('admin_index') }}'; }, 700);
    } else {
      statusDiv.textContent = 'Error: ' + (result.message || 'Unknown');
      statusDiv.style.display = 'block';
      statusDiv.style.color = 'red';
      saveBtn.textContent = originalBtnText;
      saveBtn.disabled = false;
    }
  } catch (err){
    statusDiv.textContent = 'Network error';
    statusDiv.style.display = 'block';
    statusDiv.style.color = 'red';
    saveBtn.textContent = originalBtnText;
    saveBtn.disabled = false;
  }
});

// handle delete gallery image
document.querySelectorAll('.btn-delete-image').forEach(btn => {
  btn.addEventListener('click', async function(e){
    e.preventDefault();
    const image = this.getAttribute('data-image');
    if (!confirm('Delete this image from gallery?')) return;
    try {
  const resp = await fetch("{{ url_for('admin_profile_delete_image') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ image })
      });
      const j = await resp.json();
      if (j.status === 'success') {
        // remove the preview node
        this.parentElement.remove();
      } else {
        alert('Could not delete: ' + (j.message || 'error'));
      }
    } catch (err){
      alert('Network error');
    }
  });
});
</script>
{% endblock %}
